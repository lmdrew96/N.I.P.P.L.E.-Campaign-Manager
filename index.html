<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.I.P.P.L.E. FeySpace Campaign Tracker</title>
    
    <!-- Add Mammoth.js for DOCX parsing -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    
    <!-- Intelligent Parser -->
    <script src="intelligent-parser.js"></script>
    
    <style>
        :root {
            --nipple-blue: #1a3a52;
            --nipple-teal: #2a7f7f;
            --nipple-gold: #d4a017;
            --nipple-dark: #0d1f2d;
            --nipple-light: #e8f4f8;
            --nipple-red: #d44;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--nipple-dark) 0%, var(--nipple-blue) 100%);
            color: var(--nipple-light);
            min-height: 100vh;
            padding-bottom: 3rem;
        }

        .header {
            background: rgba(13, 31, 45, 0.9);
            padding: 1rem;
            border-bottom: 3px solid var(--nipple-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            flex: 1;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .header h1 {
            color: var(--nipple-gold);
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(212, 160, 23, 0.3);
        }

        .tagline {
            color: var(--nipple-teal);
            font-style: italic;
            margin-top: 0.5rem;
        }

        .editor-toggle, .upload-button {
            background: var(--nipple-gold);
            color: var(--nipple-dark);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .upload-button {
            background: var(--nipple-teal);
            color: white;
        }

        .editor-toggle:hover, .upload-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(212, 160, 23, 0.3);
        }

        .tabs {
            display: flex;
            background: rgba(26, 58, 82, 0.8);
            padding: 0.5rem;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .tab-button {
            background: rgba(42, 127, 127, 0.3);
            border: 2px solid var(--nipple-teal);
            color: var(--nipple-light);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(42, 127, 127, 0.5);
        }

        .tab-button.active {
            background: var(--nipple-teal);
            box-shadow: 0 0 10px rgba(42, 127, 127, 0.5);
        }

        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: rgba(26, 58, 82, 0.6);
            border: 1px solid var(--nipple-teal);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            color: var(--nipple-gold);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--nipple-teal);
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card h3 {
            color: var(--nipple-teal);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-card {
            background: rgba(42, 127, 127, 0.2);
            border: 2px solid var(--nipple-teal);
        }

        .quick-dice-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .upload-zone {
            border: 3px dashed var(--nipple-teal);
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            background: rgba(42, 127, 127, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: rgba(42, 127, 127, 0.2);
            border-color: var(--nipple-gold);
        }

        .upload-zone.dragover {
            background: rgba(212, 160, 23, 0.2);
            border-color: var(--nipple-gold);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--nipple-teal);
            margin-bottom: 1rem;
        }

        .parsed-content {
            background: rgba(13, 31, 45, 0.8);
            border: 1px solid var(--nipple-gold);
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .parsed-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(42, 127, 127, 0.3);
        }

        .parsed-section h4 {
            color: var(--nipple-gold);
            margin-bottom: 0.5rem;
        }

        .import-wizard {
            max-height: 500px;
            overflow-y: auto;
        }

        .import-summary {
            background: rgba(42, 127, 127, 0.2);
            border: 2px solid var(--nipple-teal);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .found-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(212, 160, 23, 0.2);
            border-left: 3px solid var(--nipple-gold);
            border-radius: 3px;
        }

        .import-options {
            display: grid;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .import-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(42, 127, 127, 0.2);
            border-radius: 5px;
        }

        .import-option input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .parser-tip {
            background: rgba(212, 160, 23, 0.1);
            border-left: 3px solid var(--nipple-gold);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 5px;
        }

        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .alert.success {
            background: rgba(42, 127, 127, 0.3);
            border: 1px solid var(--nipple-teal);
        }

        .alert.warning {
            background: rgba(212, 160, 23, 0.2);
            border: 1px solid var(--nipple-gold);
        }

        .alert.info {
            background: rgba(26, 58, 82, 0.5);
            border: 1px solid var(--nipple-teal);
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .character-card {
            background: rgba(42, 127, 127, 0.2);
            border: 2px solid var(--nipple-teal);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }

        .character-card h3 {
            color: var(--nipple-gold);
            margin-bottom: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(42, 127, 127, 0.3);
        }

        button {
            background: var(--nipple-teal);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.25rem;
        }

        button:hover {
            background: #3a8f8f;
            box-shadow: 0 0 10px rgba(42, 127, 127, 0.5);
        }

        button.small {
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
        }

        button.danger {
            background: var(--nipple-red);
        }

        button.danger:hover {
            background: #e55;
        }

        button.gold {
            background: var(--nipple-gold);
            color: var(--nipple-dark);
        }

        button.gold:hover {
            background: #e4b027;
        }

        input, select, textarea {
            background: rgba(13, 31, 45, 0.8);
            color: var(--nipple-light);
            border: 1px solid var(--nipple-teal);
            padding: 0.5rem;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--nipple-blue);
            border: 2px solid var(--nipple-gold);
            border-radius: 10px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: var(--nipple-gold);
            margin-bottom: 1rem;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        .status-processing {
            color: var(--nipple-gold);
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }

        .help-text {
            background: rgba(212, 160, 23, 0.1);
            border-left: 3px solid var(--nipple-gold);
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .help-text h4 {
            color: var(--nipple-gold);
            margin-bottom: 0.5rem;
        }

        .help-text ul {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .quick-actions-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 31, 45, 0.95);
            border-top: 2px solid var(--nipple-gold);
            padding: 0.75rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            z-index: 100;
        }

        .quick-actions-bar button {
            margin: 0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .status-bar {
            background: rgba(13, 31, 45, 0.9);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--nipple-teal);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--nipple-teal);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s, slideOut 0.3s 2.7s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        .dm-tip {
            background: rgba(212, 160, 23, 0.1);
            border-left: 3px solid var(--nipple-gold);
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            border-radius: 3px;
        }

        body.new-dm-mode .dm-tip {
            display: block;
        }

        body:not(.new-dm-mode) .dm-tip {
            display: none;
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .template-card {
            background: rgba(42, 127, 127, 0.2);
            border: 2px solid var(--nipple-teal);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .template-card:hover {
            background: rgba(42, 127, 127, 0.4);
            border-color: var(--nipple-gold);
            transform: translateY(-2px);
        }

        .template-card h4 {
            color: var(--nipple-gold);
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .content { padding: 1rem; }
            .tabs { flex-wrap: wrap; }
            .header { text-align: center; }
            .header h1 { font-size: 1.5rem; }
            .header-buttons { justify-content: center; width: 100%; }
            .quick-actions-bar { font-size: 0.8rem; }
            .quick-actions-bar button { padding: 0.4rem 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-item">üìç Act <span id="status-act">1</span> - Level <span id="status-level">2</span></span>
        <span class="status-item">üíæ Last saved: <span id="last-save">Just now</span></span>
        <span class="status-item">‚è±Ô∏è Session: <span id="session-timer">0:00</span></span>
    </div>

    <div class="header">
        <div class="header-left">
            <h1>N.I.P.P.L.E. FeySpace Campaign</h1>
            <div class="tagline">We Go All the Way</div>
        </div>
        <div class="header-buttons">
            <button class="upload-button" onclick="openUploadModal()">üìÑ Upload Prep Doc</button>
            <button class="upload-button" onclick="openTemplateModal()">üìã Templates</button>
            <button class="editor-toggle" onclick="toggleNewDMMode()">üí° New DM Mode</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('dashboard')">üéØ Dashboard</button>
        <button class="tab-button" onclick="showTab('overview')">Overview</button>
        <button class="tab-button" onclick="showTab('characters')">Characters</button>
        <button class="tab-button" onclick="showTab('quests')">Quests</button>
        <button class="tab-button" onclick="showTab('factions')">Factions</button>
        <button class="tab-button" onclick="showTab('locations')">Locations</button>
        <button class="tab-button" onclick="showTab('loot')">Loot & Cargo</button>
        <button class="tab-button" onclick="showTab('storyline')">Storyline</button>
        <button class="tab-button" onclick="showTab('combat')">Combat</button>
        <button class="tab-button" onclick="showTab('encounters')">Encounters</button>
        <button class="tab-button" onclick="showTab('timeline')">Timeline</button>
        <button class="tab-button" onclick="showTab('dmnotes')">DM Notes</button>
        <button class="tab-button" onclick="showTab('data')">Data Manager</button>
    </div>

    <div class="content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dm-tip">
                üí° <strong>Dashboard Tip:</strong> This is your command center! Everything you need at a glance for running your session.
            </div>
            <div class="dashboard-grid">
                <!-- Active Quest Summary -->
                <div class="card dashboard-card">
                    <h3>üéØ Active Quest</h3>
                    <div id="active-quest-summary"></div>
                </div>
                
                <!-- Current Party Status -->
                <div class="card dashboard-card">
                    <h3>‚öîÔ∏è Party Status</h3>
                    <div id="party-status-quick"></div>
                </div>
                
                <!-- Quick Dice Roller -->
                <div class="card dashboard-card">
                    <h3>üé≤ Quick Rolls</h3>
                    <div class="quick-dice-buttons">
                        <button onclick="quickRoll('Perception', 'd20')">üëÅÔ∏è Perception</button>
                        <button onclick="quickRoll('Investigation', 'd20')">üîç Investigation</button>
                        <button onclick="quickRoll('Initiative', 'd20')">‚öîÔ∏è Initiative</button>
                        <button onclick="quickRoll('Random', 'd100')">üé≤ d100</button>
                    </div>
                </div>
                
                <!-- Next Planned Event -->
                <div class="card dashboard-card">
                    <h3>üìÖ What's Next?</h3>
                    <div id="next-event"></div>
                </div>

                <!-- Quick Reference -->
                <div class="card dashboard-card">
                    <h3>üìñ Quick Reference</h3>
                    <div id="quick-ref-dashboard"></div>
                </div>

                <!-- Encounter Generator -->
                <div class="card dashboard-card">
                    <h3>üé≤ Random Encounter</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        <button onclick="generateGTSCEncounter()">üê± GTSC Riding</button>
                        <button onclick="generateStationEvent()">üöâ Station Event</button>
                        <button onclick="generateFeyspaceWeird()">‚ú® FeySpace Weird</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div class="card">
                <h2>Campaign Overview</h2>
                <div id="campaign-info"></div>
            </div>
            <div class="card">
                <h2>Current Act</h2>
                <div id="current-act"></div>
            </div>
        </div>

        <!-- Characters Tab -->
        <div id="characters" class="tab-content">
            <div class="dm-tip">
                üí° <strong>Character Tip:</strong> Give each NPC one memorable trait (voice, mannerism, or catchphrase) to make them distinct.
            </div>
            <div class="card">
                <h2>
                    Player Characters
                    <button onclick="addPlayerCharacter()" class="small gold">‚ûï Add PC</button>
                </h2>
                <div class="character-grid" id="pc-grid"></div>
            </div>
            <div class="card">
                <h2>Important NPCs</h2>
                <div id="npc-list"></div>
            </div>
        </div>

        <!-- Quests Tab -->
        <div id="quests" class="tab-content">
            <div class="card">
                <h2>
                    Active Quests
                    <button onclick="addQuest()" class="small gold">‚ûï Add Quest</button>
                </h2>
                <div id="quest-list"></div>
            </div>
        </div>

        <!-- Factions Tab -->
        <div id="factions" class="tab-content">
            <div class="card">
                <h2>
                    Factions & Reputation
                    <button onclick="addFaction()" class="small gold">‚ûï Add Faction</button>
                </h2>
                <div id="faction-list"></div>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content">
            <div class="card">
                <h2>
                    Known Locations
                    <button onclick="addLocation()" class="small gold">‚ûï Add Location</button>
                </h2>
                <div id="location-list"></div>
            </div>
        </div>

        <!-- Loot Tab -->
        <div id="loot" class="tab-content">
            <div class="card">
                <h2>Party Resources</h2>
                <div id="party-resources"></div>
            </div>
            <div class="card">
                <h2>
                    Loot & Cargo
                    <button onclick="addLoot()" class="small gold">‚ûï Add Item</button>
                </h2>
                <div id="loot-list"></div>
            </div>
        </div>

        <!-- Timeline Tab -->
        <div id="timeline" class="tab-content">
            <div class="card">
                <h2>
                    Campaign Timeline
                    <button onclick="addTimelineEvent()" class="small gold">‚ûï Add Event</button>
                </h2>
                <div id="timeline-list"></div>
            </div>
        </div>

        <!-- Storyline Tab -->
        <div id="storyline" class="tab-content">
            <div class="card">
                <h2>Act Progression</h2>
                <div id="act-progression"></div>
            </div>
            <div class="card">
                <h2>Key Revelations</h2>
                <div id="revelations"></div>
            </div>
        </div>

        <!-- Combat Tab -->
        <div id="combat" class="tab-content">
            <div class="dm-tip">
                üí° <strong>Combat Tip:</strong> Adjust encounter difficulty based on party resources. If they're low on HP/spells, consider making it easier. Write initiative order on a folded card over your screen so players can see turn order.
            </div>
            <div class="card">
                <h2>Combat Initiative Tracker</h2>
                <div id="combat-tracker">
                    <div class="button-group" style="margin-bottom: 1rem;">
                        <button onclick="quickAddPCs()" class="gold">‚ö° Quick Add PCs</button>
                        <button onclick="addCombatant()">‚ûï Add Combatant</button>
                        <button onclick="startCombat()" class="gold">‚ñ∂Ô∏è Start Combat</button>
                        <button onclick="nextTurn()" class="gold">‚è≠Ô∏è Next Turn</button>
                        <button onclick="clearCombat()" class="danger">üóëÔ∏è Clear All</button>
                    </div>
                    <div id="initiative-list"></div>
                </div>
            </div>
            <div class="card">
                <h2>üé≤ Dice Roller</h2>
                <div class="dm-tip">
                    üí° <strong>Dice Tip:</strong> Roll behind the screen for tension, in the open for trust. Both have their place!
                </div>
                <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="rollDice(4)">d4</button>
                        <button onclick="rollDice(6)">d6</button>
                        <button onclick="rollDice(8)">d8</button>
                        <button onclick="rollDice(10)">d10</button>
                        <button onclick="rollDice(12)">d12</button>
                        <button onclick="rollDice(20)">d20</button>
                        <button onclick="rollDice(100)">d100</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="dice-count" value="1" min="1" max="20" style="width: 80px;">
                        <span>d</span>
                        <input type="number" id="dice-sides" value="20" min="2" max="100" style="width: 80px;">
                        <span>+</span>
                        <input type="number" id="dice-modifier" value="0" min="-20" max="20" style="width: 80px;">
                        <button onclick="rollCustomDice()" class="gold">Roll Custom</button>
                    </div>
                    <div id="dice-results" style="background: rgba(13, 31, 45, 0.8); border: 1px solid var(--nipple-teal); border-radius: 5px; padding: 1rem; min-height: 100px;"></div>
                </div>
            </div>
        </div>

        <!-- Encounters Tab -->
        <div id="encounters" class="tab-content">
            <div class="dm-tip">
                üí° <strong>Encounter Tip:</strong> Use encounter tables to add variety and surprise to your sessions!
            </div>
            <div class="card">
                <h2>Prepared Encounters</h2>
                <div id="prepared-encounters"></div>
            </div>
            <div class="card">
                <h2>üé≤ Encounter Tables</h2>
                <div id="encounter-tables"></div>
            </div>
        </div>

        <!-- DM Notes Tab -->
        <div id="dmnotes" class="tab-content">
            <div class="card">
                <h2>
                    Session Notes
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="viewSessionHistory()" class="small gold">üìú View History</button>
                        <button onclick="openTemplateModal()" class="small">üìã Use Template</button>
                    </div>
                </h2>
                <textarea id="session-notes" rows="10" placeholder="Session notes..."></textarea>
                <button onclick="saveNotes()">Save Notes</button>
            </div>
        </div>

        <!-- Data Manager Tab -->
        <div id="data" class="tab-content">
            <div class="card">
                <h2>Data Management</h2>
                <div class="button-group">
                    <button onclick="exportData()">üì• Export Campaign</button>
                    <button onclick="document.getElementById('import-file').click()">üì§ Import Campaign</button>
                    <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
        <button onclick="quickRoll('Perception', 'd20')" title="Quick perception check">üëÅÔ∏è Perception</button>
        <button onclick="randomNPC()" title="Generate random NPC name">üé≠ Random NPC</button>
        <button onclick="quickNote()" title="Quick note">üìù Note</button>
        <button onclick="startBreakTimer()" title="Start 10-min timer">‚è±Ô∏è Break</button>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <h2>üìÑ Upload Prep Document</h2>
            
            <div class="upload-zone" id="drop-zone" onclick="document.getElementById('doc-upload').click()">
                <div class="upload-icon">üìÑ</div>
                <p><strong>Click to upload or drag & drop</strong></p>
                <p>Supports .docx, .txt, and .md files</p>
                <input type="file" id="doc-upload" style="display: none;" accept=".docx,.txt,.md" onchange="handleFileSelect(event)">
            </div>

            <div class="help-text">
                <h4>üìã Parser Guide</h4>
                <p style="margin-bottom: 0.5rem;">For best results, use clear headers in your document:</p>
                <ul>
                    <li><strong>NPCs:</strong> Use headers like "NPCs", "Characters", or "Cast"</li>
                    <li><strong>Encounters:</strong> Use "Encounters", "Combat", or "Battles"</li>
                    <li><strong>Revelations:</strong> Use "Secrets", "Revelations", or "Plot Twists"</li>
                    <li><strong>Items:</strong> Use "Items", "Loot", or "Treasure"</li>
                </ul>
                <p style="margin-top: 0.5rem; font-style: italic;">The parser will do its best to identify content even without headers!</p>
            </div>

            <div id="parse-status"></div>
            <div id="parsed-preview"></div>
            
            <div class="button-group">
                <button onclick="closeUploadModal()" class="danger">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <h2>üìã Session Prep Templates</h2>
            <p style="margin-bottom: 1rem;">Choose a template to get started with your session prep:</p>
            
            <div class="template-selector">
                <div class="template-card" onclick="insertTemplate('session')">
                    <h4>üìù Session Prep</h4>
                    <p>Full session structure with scenes, NPCs, and encounters</p>
                </div>
                <div class="template-card" onclick="insertTemplate('npc')">
                    <h4>üé≠ NPC Template</h4>
                    <p>Quick NPC creation with personality and secrets</p>
                </div>
                <div class="template-card" onclick="insertTemplate('dungeon')">
                    <h4>üè∞ Dungeon/Location</h4>
                    <p>Room-by-room dungeon or location layout</p>
                </div>
                <div class="template-card" onclick="insertTemplate('encounter')">
                    <h4>‚öîÔ∏è Encounter</h4>
                    <p>Combat or social encounter template</p>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="closeTemplateModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Load campaign data from JSON and initialize
        let campaignData = {};
        
        fetch('campaign-data.json')
            .then(response => response.json())
            .then(data => {
                campaignData = data;
                init();
            })
            .catch(err => {
                console.log('Using default data');
                campaignData = {
                    overview: { setting: "FeySpace", theme: "Corporate satire meets cosmic horror", currentLevel: 2, currentAct: 1 },
                    acts: [], playerCharacters: [], npcs: [], revelations: [], preparedEncounters: [],
                    quests: [], factions: [], locations: [], loot: [], timeline: [], encounterTables: {},
                    quickReference: [], dmReference: []
                };
                init();
            });
        
        function init() {
            loadFromLocalStorage();
            populateContent();
            startSessionTimer();
            updateStatusBar();
        }
        
        let sessionStartTime = Date.now();
        let diceHistory = [];
        let combatants = [];
        let currentTurn = 0;
        let combatActive = false;
        let parsedDocument = null;
        
        const prepTemplates = {
            session: `# Session [Number] - [Title]\n\n## Summary\nWhat happened last time...\n\n## Scene 1: [Name]\n**Read Aloud:** \n**GM Notes:** \n**Checks:** \n\n## NPCs\n**Name** - Role\n- Description\n- Secret: \n\n## Encounters\n**Name** - CR X\n- Type: Combat/Social/Puzzle\n\n## Loot\n- Item (value)`,
            npc: `# NPC: [Name]\n**Role:** \n**Description:** \n**Personality:** \n**Goals:** \n**Secret:** \n**Catchphrase:** `,
            dungeon: `# Dungeon: [Name]\n\n## Room 1: [Entry]\n**Read Aloud:** \n**Contents:** \n**Exits:** \n**Treasure:** \n\n## Room 2: [Name]\n**Read Aloud:** \n**Contents:** \n**Exits:** `,
            encounter: `# Encounter: [Name]\n**Type:** Combat/Social/Puzzle\n**CR:** \n**Description:** \n\n## Setup\n**Location:** \n**Trigger:** \n\n## Enemies/NPCs\n- **Name** (CR X): HP, AC, Special\n\n## Tactics\n**Round 1:** \n**If losing:** \n**Victory:** \n**Defeat:** `
        };
        
        const npcNames = {
            first: ['Zara', 'Kael', 'Finn', 'Nova', 'Rex', 'Luna', 'Ash', 'Sage', 'River', 'Storm'],
            last: ['Voss', 'Drake', 'Stone', 'Frost', 'Blaze', 'Shadow', 'Swift', 'Bright', 'Dark', 'Star']
        };
        
        function startSessionTimer() {
            setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('session-timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function updateStatusBar() {
            document.getElementById('status-act').textContent = campaignData.overview?.currentAct || 1;
            document.getElementById('status-level').textContent = campaignData.overview?.currentLevel || 2;
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function toggleNewDMMode() {
            document.body.classList.toggle('new-dm-mode');
            showToast(document.body.classList.contains('new-dm-mode') ? 'New DM Mode: ON' : 'New DM Mode: OFF');
        }
        
        function quickRoll(name, dice) {
            const sides = parseInt(dice.replace('d', ''));
            const result = Math.floor(Math.random() * sides) + 1;
            showToast(`${name}: ${result}`);
        }
        
        function randomNPC() {
            const first = npcNames.first[Math.floor(Math.random() * npcNames.first.length)];
            const last = npcNames.last[Math.floor(Math.random() * npcNames.last.length)];
            showToast(`Random NPC: ${first} ${last}`);
        }
        
        function quickNote() {
            const note = prompt('Quick note:');
            if (note) {
                const notes = document.getElementById('session-notes');
                notes.value += (notes.value ? '\n\n' : '') + `[${new Date().toLocaleTimeString()}] ${note}`;
                showToast('Note added!');
            }
        }
        
        function startBreakTimer() {
            const minutes = prompt('Break duration in minutes:', '10');
            if (minutes) showToast(`Break timer: ${minutes} minutes`);
        }
        
        function generateGTSCEncounter() {
            if (campaignData.encounterTables?.gtscRiding) {
                const table = campaignData.encounterTables.gtscRiding;
                const result = table[Math.floor(Math.random() * table.length)];
                alert(`üê± GTSC Riding Event\n\n${result.name}\n\n${result.description}`);
            } else {
                showToast('No GTSC encounter table found!');
            }
        }
        
        function generateStationEvent() {
            if (campaignData.encounterTables?.stationEvents) {
                const table = campaignData.encounterTables.stationEvents;
                const result = table[Math.floor(Math.random() * table.length)];
                alert(`üöâ Station Event\n\n${result.name}\n\n${result.description}`);
            } else {
                showToast('No station event table found!');
            }
        }
        
        function generateFeyspaceWeird() {
            if (campaignData.encounterTables?.feyspaceWeird) {
                const table = campaignData.encounterTables.feyspaceWeird;
                const result = table[Math.floor(Math.random() * table.length)];
                alert(`‚ú® FeySpace Weirdness\n\n${result.name}\n\n${result.description}`);
            } else {
                showToast('No FeySpace weird table found!');
            }
        }
        
        function openTemplateModal() {
            document.getElementById('template-modal').classList.add('active');
        }
        
        function closeTemplateModal() {
            document.getElementById('template-modal').classList.remove('active');
        }
        
        function insertTemplate(type) {
            document.getElementById('session-notes').value = prepTemplates[type];
            closeTemplateModal();
            showToast('Template inserted!');
        }
        
        function openUploadModal() {
            document.getElementById('upload-modal').classList.add('active');
        }
        
        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('active');
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const status = document.getElementById('parse-status');
            status.innerHTML = '<div class="status-processing">Processing document...</div>';
            
            const fileName = file.name.toLowerCase();
            let content = '';
            
            try {
                if (fileName.endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    content = result.value;
                } else if (fileName.endsWith('.txt') || fileName.endsWith('.md')) {
                    content = await file.text();
                } else {
                    throw new Error('Unsupported file type');
                }
                
                // Use the intelligent parser
                const parser = new IntelligentParser();
                parsedDocument = parser.parse(content);
                displayParsedContent(parsedDocument);
                
            } catch (error) {
                status.innerHTML = `<div style="color: var(--nipple-red);">Error: ${error.message}</div>`;
            }
        }
        
        function displayParsedContent(parsed) {
            const preview = document.getElementById('parsed-preview');
            
            let html = '<div class="import-wizard">';
            
            // Show confidence feedback
            const confidence = parsed.confidence;
            if (confidence > 0.7) {
                html += '<div class="alert success">‚úÖ High confidence parse! Found clear sections.</div>';
            } else if (confidence > 0.4) {
                html += '<div class="alert warning">‚ö†Ô∏è Medium confidence. Consider using headers like "NPCs:", "Encounters:", etc.</div>';
            } else {
                html += '<div class="alert info">‚ÑπÔ∏è Low confidence. Try our templates for better results! <button onclick="openTemplateModal()" class="small gold">View Templates</button></div>';
            }
            
            // Show warnings if any
            if (parsed.warnings && parsed.warnings.length > 0) {
                parsed.warnings.forEach(warning => {
                    html += `<div class="alert warning">‚ö†Ô∏è ${warning}</div>`;
                });
            }
            
            // Show summary
            html += '<div class="import-summary"><h3>We found:</h3>';
            if (parsed.npcs.length > 0) html += `<div class="found-item">üë• ${parsed.npcs.length} NPCs</div>`;
            if (parsed.encounters.length > 0) html += `<div class="found-item">‚öîÔ∏è ${parsed.encounters.length} Encounters</div>`;
            if (parsed.revelations.length > 0) html += `<div class="found-item">üîÆ ${parsed.revelations.length} Revelations</div>`;
            if (parsed.items.length > 0) html += `<div class="found-item">üíé ${parsed.items.length} Items</div>`;
            if (parsed.quests.length > 0) html += `<div class="found-item">üéØ ${parsed.quests.length} Quests</div>`;
            if (parsed.locations.length > 0) html += `<div class="found-item">üìç ${parsed.locations.length} Locations</div>`;
            if (parsed.factions.length > 0) html += `<div class="found-item">üèõÔ∏è ${parsed.factions.length} Factions</div>`;
            if (parsed.plotHooks.length > 0) html += `<div class="found-item">üé£ ${parsed.plotHooks.length} Plot Hooks</div>`;
            if (parsed.mechanics.length > 0) html += `<div class="found-item">‚öôÔ∏è ${parsed.mechanics.length} Mechanics</div>`;
            if (parsed.lore.length > 0) html += `<div class="found-item">üìú ${parsed.lore.length} Lore Entries</div>`;
            html += '</div>';
            
            // Import options
            html += '<div class="import-options">';
            if (parsed.npcs.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-npcs" checked> Import ${parsed.npcs.length} NPCs</label>`;
            }
            if (parsed.encounters.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-encounters" checked> Import ${parsed.encounters.length} Encounters</label>`;
            }
            if (parsed.revelations.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-revelations" checked> Import ${parsed.revelations.length} Revelations</label>`;
            }
            if (parsed.items.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-items" checked> Import ${parsed.items.length} Items</label>`;
            }
            if (parsed.quests.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-quests" checked> Import ${parsed.quests.length} Quests</label>`;
            }
            if (parsed.locations.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-locations" checked> Import ${parsed.locations.length} Locations</label>`;
            }
            if (parsed.factions.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-factions" checked> Import ${parsed.factions.length} Factions</label>`;
            }
            if (parsed.plotHooks.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-plothooks" checked> Import ${parsed.plotHooks.length} Plot Hooks</label>`;
            }
            if (parsed.mechanics.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-mechanics" checked> Import ${parsed.mechanics.length} Mechanics</label>`;
            }
            if (parsed.lore.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-lore" checked> Import ${parsed.lore.length} Lore</label>`;
            }
            if (parsed.notes.length > 0) {
                html += `<label class="import-option"><input type="checkbox" id="import-notes" checked> Add to Session Notes</label>`;
            }
            html += '</div>';
            
            html += '<div class="parser-tip">üí° For best results, use headers like "NPCs:", "Encounters:", etc. <button onclick="openTemplateModal()" class="small">View Guide</button></div>';
            
            html += '</div>';
            
            html += '<div class="button-group">';
            html += '<button class="gold" onclick="importParsedContent()">Import Selected</button>';
            html += '<button onclick="closeUploadModal()">Cancel</button>';
            html += '</div>';
            
            preview.innerHTML = html;
            document.getElementById('parse-status').innerHTML = '';
        }
        
        function importParsedContent() {
            if (!parsedDocument) return;
            
            let imported = [];
            
            if (document.getElementById('import-npcs')?.checked && parsedDocument.npcs.length > 0) {
                if (!campaignData.npcs) campaignData.npcs = [];
                campaignData.npcs.push(...parsedDocument.npcs);
                imported.push(`${parsedDocument.npcs.length} NPCs`);
            }
            
            if (document.getElementById('import-encounters')?.checked && parsedDocument.encounters.length > 0) {
                if (!campaignData.preparedEncounters) campaignData.preparedEncounters = [];
                campaignData.preparedEncounters.push(...parsedDocument.encounters);
                imported.push(`${parsedDocument.encounters.length} Encounters`);
            }
            
            if (document.getElementById('import-revelations')?.checked && parsedDocument.revelations.length > 0) {
                if (!campaignData.revelations) campaignData.revelations = [];
                campaignData.revelations.push(...parsedDocument.revelations);
                imported.push(`${parsedDocument.revelations.length} Revelations`);
            }
            
            if (document.getElementById('import-items')?.checked && parsedDocument.items.length > 0) {
                if (!campaignData.items) campaignData.items = [];
                campaignData.items.push(...parsedDocument.items);
                imported.push(`${parsedDocument.items.length} Items`);
            }
            
            if (document.getElementById('import-quests')?.checked && parsedDocument.quests.length > 0) {
                if (!campaignData.quests) campaignData.quests = [];
                parsedDocument.quests.forEach(quest => {
                    campaignData.quests.push({
                        ...quest,
                        status: 'active'
                    });
                });
                imported.push(`${parsedDocument.quests.length} Quests`);
            }
            
            if (document.getElementById('import-locations')?.checked && parsedDocument.locations.length > 0) {
                if (!campaignData.locations) campaignData.locations = [];
                campaignData.locations.push(...parsedDocument.locations);
                imported.push(`${parsedDocument.locations.length} Locations`);
            }
            
            if (document.getElementById('import-factions')?.checked && parsedDocument.factions.length > 0) {
                if (!campaignData.factions) campaignData.factions = [];
                campaignData.factions.push(...parsedDocument.factions);
                imported.push(`${parsedDocument.factions.length} Factions`);
            }
            
            if (document.getElementById('import-plothooks')?.checked && parsedDocument.plotHooks.length > 0) {
                if (!campaignData.plotHooks) campaignData.plotHooks = [];
                campaignData.plotHooks.push(...parsedDocument.plotHooks);
                imported.push(`${parsedDocument.plotHooks.length} Plot Hooks`);
            }
            
            if (document.getElementById('import-mechanics')?.checked && parsedDocument.mechanics.length > 0) {
                if (!campaignData.mechanics) campaignData.mechanics = [];
                campaignData.mechanics.push(...parsedDocument.mechanics);
                imported.push(`${parsedDocument.mechanics.length} Mechanics`);
            }
            
            if (document.getElementById('import-lore')?.checked && parsedDocument.lore.length > 0) {
                if (!campaignData.lore) campaignData.lore = [];
                campaignData.lore.push(...parsedDocument.lore);
                imported.push(`${parsedDocument.lore.length} Lore`);
            }
            
            if (document.getElementById('import-notes')?.checked && parsedDocument.notes.length > 0) {
                const currentNotes = document.getElementById('session-notes').value;
                const newNotes = parsedDocument.notes.join('\n\n');
                document.getElementById('session-notes').value = 
                    currentNotes + (currentNotes ? '\n\n--- Imported Notes ---\n\n' : '') + newNotes;
                imported.push('Session Notes');
            }
            
            saveToLocalStorage();
            populateContent();
            closeUploadModal();
            
            showToast(`‚úÖ Imported: ${imported.join(', ')}`);
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'dashboard') updateDashboard();
        }
        
        function updateDashboard() {
            // Active Quest
            const activeQuestDiv = document.getElementById('active-quest-summary');
            if (campaignData.quests?.length > 0) {
                const quest = campaignData.quests.find(q => q.status === 'active');
                if (quest) {
                    activeQuestDiv.innerHTML = `<h4 style="color: var(--nipple-gold);">${quest.title}</h4><p>${quest.giver || 'Unknown'}</p>`;
                } else {
                    activeQuestDiv.innerHTML = '<p>No active quests</p>';
                }
            } else {
                activeQuestDiv.innerHTML = '<p>No quests yet</p>';
            }
            
            // Party Status
            const partyDiv = document.getElementById('party-status-quick');
            if (campaignData.playerCharacters?.length > 0) {
                partyDiv.innerHTML = campaignData.playerCharacters.map(pc => 
                    `<div style="padding: 0.5rem; background: rgba(42, 127, 127, 0.2); border-radius: 5px; margin-bottom: 0.5rem;">
                        <strong>${pc.name}</strong> - ${pc.class} ${pc.level}<br>
                        HP: ${pc.hp} | AC: ${pc.ac}
                    </div>`
                ).join('');
            } else {
                partyDiv.innerHTML = '<p>No characters yet</p>';
            }
            
            // Next Event
            const nextEventDiv = document.getElementById('next-event');
            if (campaignData.timeline?.length > 0) {
                const future = campaignData.timeline.filter(e => e.date.includes('planned'));
                if (future.length > 0) {
                    nextEventDiv.innerHTML = `<p><strong>${future[0].date}</strong><br>${future[0].event}</p>`;
                } else {
                    nextEventDiv.innerHTML = '<p>No planned events</p>';
                }
            } else {
                nextEventDiv.innerHTML = '<p>No timeline yet</p>';
            }
            
            // Quick Reference
            const quickRefDiv = document.getElementById('quick-ref-dashboard');
            if (campaignData.quickReference?.length > 0) {
                quickRefDiv.innerHTML = campaignData.quickReference.slice(0, 3).map(ref =>
                    `<div style="padding: 0.5rem; background: rgba(212, 160, 23, 0.1); border-radius: 5px; margin-bottom: 0.5rem;">
                        <strong>${ref.title}</strong><br>
                        <small>${ref.content}</small>
                    </div>`
                ).join('');
            } else {
                quickRefDiv.innerHTML = '<p>No quick reference items</p>';
            }
        }
        
        function populateContent() {
            // Campaign Info
            if (campaignData.overview) {
                document.getElementById('campaign-info').innerHTML = `
                    <p><strong>Setting:</strong> ${campaignData.overview.setting}</p>
                    <p><strong>Theme:</strong> ${campaignData.overview.theme}</p>
                    <p><strong>Current Level:</strong> ${campaignData.overview.currentLevel}</p>
                `;
            }
            
            // Current Act
            if (campaignData.acts?.length > 0) {
                const act = campaignData.acts.find(a => a.id === campaignData.overview.currentAct);
                if (act) {
                    document.getElementById('current-act').innerHTML = `
                        <div style="background: rgba(42, 127, 127, 0.2); border: 2px solid var(--nipple-teal); border-radius: 8px; padding: 1rem;">
                            <h3>${act.name}</h3>
                            <p><em>${act.tone}</em></p>
                            <p><strong>Levels:</strong> ${act.levels}</p>
                            <p>${act.description}</p>
                        </div>
                    `;
                }
            }
            
            // NPCs
            if (campaignData.npcs?.length > 0) {
                document.getElementById('npc-list').innerHTML = campaignData.npcs.map(npc => `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(13, 31, 45, 0.6); border-left: 3px solid var(--nipple-gold); border-radius: 5px;">
                        <h3>${npc.name}</h3>
                        ${npc.role ? `<p><strong>Role:</strong> ${npc.role}</p>` : ''}
                        <p>${npc.description}</p>
                        ${npc.secret ? `<p><em>Secret: ${npc.secret}</em></p>` : ''}
                        ${npc.catchphrase ? `<p><strong>"${npc.catchphrase}"</strong></p>` : ''}
                    </div>
                `).join('');
            }
            
            // Encounters
            if (campaignData.preparedEncounters?.length > 0) {
                document.getElementById('prepared-encounters').innerHTML = campaignData.preparedEncounters.map(enc => `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(13, 31, 45, 0.6); border-left: 3px solid var(--nipple-gold); border-radius: 5px;">
                        <h3>${enc.name}</h3>
                        <p><strong>Type:</strong> ${enc.type} ${enc.cr ? `| <strong>CR:</strong> ${enc.cr}` : ''}</p>
                        <p>${enc.description}</p>
                    </div>
                `).join('');
            }
            
            updateDashboard();
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('nipple-campaign', JSON.stringify(campaignData));
            document.getElementById('last-save').textContent = 'Just now';
            showToast('Saved!');
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('nipple-campaign');
            if (saved) {
                const savedData = JSON.parse(saved);
                campaignData = {...campaignData, ...savedData};
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(campaignData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'nipple-campaign-data.json';
            link.click();
            showToast('Campaign exported!');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    campaignData = JSON.parse(e.target.result);
                    saveToLocalStorage();
                    populateContent();
                    showToast('Campaign imported!');
                } catch (error) {
                    showToast('Error importing data!');
                }
            };
            reader.readAsText(file);
        }
        
        function saveNotes() {
            localStorage.setItem('nipple-notes', document.getElementById('session-notes').value);
            showToast('Notes saved!');
        }
        
        function viewSessionHistory() {
            showToast('Session history feature coming soon!');
        }
        
        // Dice roller functions
        function rollDice(sides) {
            const result = Math.floor(Math.random() * sides) + 1;
            showToast(`d${sides}: ${result}`);
            displayDiceResult(`1d${sides}`, [result], result);
        }
        
        function rollCustomDice() {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            const sides = parseInt(document.getElementById('dice-sides').value) || 20;
            const modifier = parseInt(document.getElementById('dice-modifier').value) || 0;
            
            const rolls = [];
            let total = 0;
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            total += modifier;
            
            displayDiceResult(`${count}d${sides}${modifier !== 0 ? (modifier > 0 ? '+' : '') + modifier : ''}`, rolls, total);
        }
        
        function displayDiceResult(dice, rolls, total) {
            const resultsDiv = document.getElementById('dice-results');
            const html = `
                <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: rgba(42, 127, 127, 0.2); border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>${dice}</strong></span>
                        <span style="color: var(--nipple-gold); font-size: 1.2rem; font-weight: bold;">${total}</span>
                    </div>
                    ${rolls.length > 1 ? `<div style="font-size: 0.85rem; color: var(--nipple-teal); margin-top: 0.25rem;">Rolls: [${rolls.join(', ')}]</div>` : ''}
                </div>
            `;
            resultsDiv.innerHTML = html + resultsDiv.innerHTML;
        }
        
        // Combat functions (simplified)
        function addCombatant() { showToast('Combat tracker coming soon!'); }
        function quickAddPCs() { showToast('Quick add PCs coming soon!'); }
        function startCombat() { showToast('Combat tracker coming soon!'); }
        function nextTurn() { showToast('Combat tracker coming soon!'); }
        function clearCombat() { showToast('Combat tracker coming soon!'); }
        
        // Character management (simplified)
        function addPlayerCharacter() { showToast('Character management coming soon!'); }
        function addQuest() { showToast('Quest management coming soon!'); }
        function addFaction() { showToast('Faction management coming soon!'); }
        function addLocation() { showToast('Location management coming soon!'); }
        function addLoot() { showToast('Loot management coming soon!'); }
        function addTimelineEvent() { showToast('Timeline management coming soon!'); }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'd':
                        e.preventDefault();
                        rollDice(20);
                        break;
                    case 'n':
                        e.preventDefault();
                        quickNote();
                        break;
                    case 's':
                        e.preventDefault();
                        saveToLocalStorage();
                        break;
                }
            }
        });
    </script>
</body>
</html>
